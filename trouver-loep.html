<!DOCTYPE html>
<html lang="fr">
<head>
        <meta charset="utf-8" />
        <title>Trouver l'OEP</title>
        <link rel="stylesheet" href="https://baboonrce.github.io/theme/css/main.css" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://baboonrce.github.io/">Baboon's Blog </a></h1>
                <nav><ul>
                    <li><a href="https://baboonrce.github.io/category/misc.html">MISC</a></li>
                    <li class="active"><a href="https://baboonrce.github.io/category/unpacking.html">Unpacking</a></li>
                </ul>
                </nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="https://baboonrce.github.io/trouver-loep.html" rel="bookmark"
           title="Permalink to Trouver l'OEP">Trouver l'OEP</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <span>dim. 06 novembre 2016</span>
<span>| tags: <a href="https://baboonrce.github.io/tag/denuvo.html">Denuvo</a><a href="https://baboonrce.github.io/tag/unpacking.html">unpacking</a><a href="https://baboonrce.github.io/tag/fail.html">fail</a><a href="https://baboonrce.github.io/tag/oep.html">OEP</a></span>
</footer><!-- /.post-info -->      <p>Aujourd'hui on se lance tout doucement dans l'unpacking de Just Cause 3 et on commence... par le commencement c'est à dire la détection de l'OEP (Original Entry Point, le point d'entrée du jeu avant qu'il ait été packé).</p>
<p>Plusieurs techniques plus ou moins génériques permettent de retrouver l'OEP d'un programme, il ne s'agit pas de l'étape la plus compliquée. De nombreux papers académiques se vantent d'ailleurs régulièrement d'unpacker automatiquement une foultitude de packer alors qu'ils se contentent de retrouver l'OEP d'un programme packé. Les méthodes génériques se basent souvent sur un historique des pages écrites et exécutées : si une page mémoire a été écrite puis exécutée, il y a de forte chance qu'elle corresponde à une portion de code qui a été déchiffrée / décompressée / décodée et donc potentiellement le code original. Plusieurs techniques peuvent être utilisées pour faire ça, la plus simple est de modifier les droits des pages de manière à ce qu'une écriture ou une exécution génère une exception. D'autres méthodes utilisent des techniques un peu plus avancées avec du data tainting, de l'émulation etc. mais c'est souvent un peu overkill...</p>
<p>Généralement la bonne combinaison pour retrouver un OEP pour un packer donné est de poser des hooks sur des APIs qu'on sait être utilisées en fin d'unpack et d'utiliser ensuite VirtualProtect pour modifier les droits des pages susceptibles de contenir l'OEP (les sections exécutables du PE). On monitore ensuite les exceptions avec un petit hook dans KiUserExceptionDispatcher (ou une API un peu plus basse pour éviter une détection) ou un vectored exception handler et on arrive à retrouver notre OEP.</p>
<p>Parfois des stolen bytes sont utilisées et compliquent la tache (les X premières instructions à l'OEP sont effacées de leur emplacement original, polymorphisées et placées dans de la mémoire allouée) on a donc plus d'OEP à proprement parler, les méthodes génériques ne fonctionnent plus, il faut reconstruire le code original, trouver un moyen spécifique de déterminer où le code du packer s'arrête et où celui de l'exe original commence mais c'est une autre histoire...</p>
<p>Revenons à nos moutons. La première chose que je fais quand je dois unpacker une cible est tout simplement de la lancer et de m'y attacher pour explorer un peu son code. Le plus simple pour éviter les anti-X est de suspendre le processus (via Process Hacker par exemple, bien supérieur à Process Explorer cela dit en passant). Une fois cette manipulation effectuée, la seule manière possible pour notre cible de détecter un debugger est d'utiliser tiers (processus, service, driver) ou de hooker la fonction DbgUiRemoteBreakin. Dans le premier cas il suffit de suspendre ou unloader tout ce qui peut nous détecter (contre les drivers, WIN64AST est particulièrement utile). Dans le second cas, il suffit de hooker DbgUiIssueRemoteBreakin dans le debugger pour l'empêcher de créer un thread dans le processus cible (étrangement, je n'ai vu aucun plugin faire ça). Dans le cas de Just Cause 3, aucune protection de ce type ne semble avoir été mise en place il suffit donc de suspendre tout les processus Steam ainsi que Just Cause et de s'attacher au processus avec x64dbg.</p>
<p>Une fois attaché au processus on peut observer différentes choses :</p>
<ul>
<li>Just Cause semble être compilé avec Visual Studio (utilisation de MSVCR100.dll)</li>
<li>Le code semble être dans l'avant dernière section .data (en RWX..)</li>
<li>Mis à part 2 adresses invalides dans l'IAT il ne semble pas y avoir de redirection d'APIs (???).</li>
<li>En remontant un peu la call stack de la main thread, on retrouve vite l'entry point et aucun stolen byte ne semble être présents.</li>
</ul>
<p>Une autre méthode très rapide pour retrouver l'OEP d'un programme compilé avec Visual Studio est de rechercher la constante 0x2B992DDFA232, il s'agit en effet de la valeur par défaut du __security_cookie initialisé au tout début de l'exécution du programme. Dans la catpure d'écran ci-dessous (magnifiée avec grâce sous Paint), vous pouvez voir l'EP de x64dbg (excellent débugger au fait) avec les symboles associés et en dessous l'OEP de JC3. On voit tout de suite la similitude et la fameuse constante.</p>
<p><img alt="Capture d'écran montrant les similitudes entre l'EP de x64dbg et l'OEP de JC3" src="https://baboonrce.github.io/images/OEP.png" title="Capture d'écran montrant les similitudes entre l'EP de x64dbg et l'OEP de JC3" /></p>
<p>Maintenant que nous avons notre OEP, nous aimerions bien y poser un breakpoint de manière à avoir notre programme dans un état "dumpable". Ce n'est pas si facile que ça pour les raisons suivantes :</p>
<ul>
<li>il y a peut être des anti-X un peu partout pendant le chargement du jeu ;</li>
<li>il est impossible de jouer à JC3 sans compte steam (ce qui est un peu nul je trouve...) ;</li>
<li>les jeux steam sont lancés par Steam et le chargement implique plusieurs processus, il faut donc suivre les processus créé ;</li>
<li>il n'y a pas de follow fork mode trivial sous Windows.</li>
</ul>
<p>Nous allons donc utiliser <a href="http://www.frida.re/" title="Home page de Frida">Frida</a> ! Frida est au premier abord un tool sans aucun sens, il s'agit en effet d'un framework permettant (entre autre...) de créer des scripts python (mais aussi JavaScript, QML, Swift, .NET) qui injectent du C/C++ scripté en JavaScript (via v8 ou duktape) pour reverser de l’assembleur (x86, x86_64, ARM, ARM64 mais aussi des langages plus haut niveau comme de l'Objective-C ou du dalvik) sous Windows (ou Mac, Linux, iOS, Android et... QNX). J'étais incroyablement sceptique au départ mais il s'avère que ce choix du JS n'est pas bête du tout (portabilité, dépendances très faible, énorme quantité de libs existantes en pure JS, asynchrone de base etc.) en plus Frida est extrêmement bien codé, agréable à utilisé et oleavr est quelqu'un de très accessible et serviable. Mais trêve de compliments, Frida ne supporte pas le suivi de processus, il va donc nous falloir l'implémenter.</p>
<p>Le principe est relativement simple, on va se contenter de lancer Steam en y attachant Frida et dès qu'un nouveau processus est créé, on injecte Frida dedans. Pour cela on hook CreateProcessInternalW et dès qu'un processus est créé, on remonte un évènement à notre script python depuis notre JS, notre script python va alors utiliser WinAppDbg pour poser un EBFE sur RtlUserThreadStart. Dès que le nouveau processus est initialisé et avant que l'entry point du nouveau processus soit appelé, on injecte Frida. Enfin on envoi un message au processus parent pour lui dire qu'il peut continuer son exécution. Il y a quelques subtilités pour gérer les processus 32 et 64 bits (les processus Steam vs le jeu) mais ça se gère relativement bien... Frida a aussi un petit bug (pour lequel un patch est en cours de test) et n'est pas capable de s'attacher correctement aux processus lancé avec un integrity level à untrusted, ce qui est le cas pour certains processus de Steam (notamment ceux affichant du contenu Web) heureusement ce bug ne nous empêche pas de lancer notre jeu.</p>
<p>Maintenant que nous avons Frida injecté dans tout les processus y compris celui de JC3, il nous suffit de mettre un hook sur une API utilisée au tout début de l'exécution du processus et nous aurons gagné. J'ai choisi arbitrairement d'utiliser RtlQueryPerformanceCounter qui est encore une fois utilisé pour le calcul du __security_cookie.</p>
<p>Le code est ci-dessous (d'abord le script python, puis le JS (oui je sais s'complètement con de foutre du code inline dans un blog post alors que j'ai un compte github, mais j'm'en fous)) :</p>
<div class="highlight"><pre><span></span><span class="c1"># coding: utf-8</span>
<span class="kn">import</span> <span class="nn">frida</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">winappdbg</span> <span class="kn">import</span> <span class="n">System</span><span class="p">,</span> <span class="n">Process</span><span class="p">,</span> <span class="n">HexDump</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>

<span class="n">sessions</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">PIDs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">threads</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">continue_events</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">system</span> <span class="o">=</span> <span class="n">System</span><span class="p">()</span>

<span class="n">RtlUserThreadStart</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">def</span> <span class="nf">get_RtlUserThreadStart_addr</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ntdll_path</span><span class="p">):</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">frida</span><span class="o">.</span><span class="n">spawn</span><span class="p">((</span><span class="n">path</span><span class="p">,))</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">frida</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">enumerate_modules</span><span class="p">()</span> <span class="p">:</span>
        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">ntdll_path</span><span class="p">)</span> <span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">enumerate_exports</span><span class="p">()</span> <span class="p">:</span>
                <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;RtlUserThreadStart&#39;</span> <span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
                <span class="n">frida</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;unable to find RtlUserThreadStart&#39;</span><span class="p">)</span>
            <span class="k">break</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="n">session</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
        <span class="n">frida</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;unable to find ntdll&#39;</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
    <span class="n">frida</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">relative_address</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">base_address</span>

<span class="n">RtlUserThreadStart</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span><span class="n">get_RtlUserThreadStart_addr</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\\</span><span class="s1">SysWow64</span><span class="se">\\</span><span class="s1">notepad.exe&#39;</span><span class="o">%</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;WINDIR&#39;</span><span class="p">],</span> <span class="s1">&#39;syswow64</span><span class="se">\\</span><span class="s1">ntdll.dll&#39;</span><span class="p">)</span>
<span class="n">RtlUserThreadStart</span><span class="p">[</span><span class="mi">64</span><span class="p">]</span> <span class="o">=</span><span class="n">get_RtlUserThreadStart_addr</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\\</span><span class="s1">notepad.exe&#39;</span><span class="o">%</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;WINDIR&#39;</span><span class="p">],</span> <span class="s1">&#39;system32</span><span class="se">\\</span><span class="s1">ntdll.dll&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">follow_proc_callback</span><span class="p">(</span><span class="n">script</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">follow_proc_callback_priv</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span> <span class="n">message</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;error&#39;</span> <span class="p">:</span>
            <span class="n">pprint</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">print</span> <span class="n">message</span><span class="p">[</span><span class="s1">&#39;stack&#39;</span><span class="p">]</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">message</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;send&#39;</span> <span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="s1">&#39;payload&#39;</span><span class="p">]</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;event&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;new process&#39;</span> <span class="p">:</span>
                <span class="k">print</span> <span class="s1">&#39;New process!&#39;</span>
                <span class="n">pid</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;PID&#39;</span><span class="p">]</span>
                <span class="n">creation_flags</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;creation_flags&#39;</span><span class="p">]</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
                <span class="n">bps</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">bp_address</span> <span class="ow">in</span> <span class="n">RtlUserThreadStart</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="p">:</span>
                    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_address_readable</span><span class="p">(</span><span class="n">bp_address</span><span class="p">)</span> <span class="p">:</span>
                        <span class="n">bps</span><span class="p">[</span><span class="n">bp_address</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">bp_address</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="n">p</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bp_address</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\xEB\xFE</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get_thread</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get_thread_ids</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">p</span><span class="o">.</span><span class="n">resume</span><span class="p">()</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="n">bps</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get_pc</span><span class="p">())</span> <span class="p">:</span>
                    <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">suspend</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">addr</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">bps</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">:</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                <span class="n">follow_proc</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">js</span><span class="p">,</span> <span class="n">follow_proc_callback</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">creation_flags</span> <span class="o">&amp;</span> <span class="mh">0x4</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">resume</span><span class="p">()</span>
                <span class="n">script</span><span class="o">.</span><span class="n">post</span><span class="p">({</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;continue_</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">pid</span><span class="p">})</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;possible OEP&#39;</span> <span class="p">:</span>
                <span class="n">continue_events</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">script</span><span class="p">,</span> <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;continue_event&#39;</span><span class="p">]))</span>
                <span class="k">print</span> <span class="s2">&quot;We reached the OEP (</span><span class="si">%s</span><span class="s2">-</span><span class="si">%s</span><span class="s2">), you can know attach your debugger (or press r to resume the process)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="s1">&#39;OEP&#39;</span><span class="p">],</span> <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;OEP_VA&#39;</span><span class="p">])</span>
                <span class="k">return</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;unknown message&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">follow_proc_callback_priv</span>

<span class="k">def</span> <span class="nf">follow_proc</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">js</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">PIDs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">frida</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">disable_jit</span><span class="p">()</span>
    <span class="n">sessions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
    <span class="n">script</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">create_script</span><span class="p">(</span><span class="n">js</span><span class="p">)</span>
    <span class="n">script</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="p">(</span><span class="n">script</span><span class="p">))</span>
    <span class="n">script</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;find_oep.js&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span> <span class="p">:</span>
    <span class="n">js</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">pid</span> <span class="o">=</span> <span class="n">frida</span><span class="o">.</span><span class="n">spawn</span><span class="p">((</span><span class="s2">&quot;C:</span><span class="se">\\</span><span class="s2">Program Files (x86)</span><span class="se">\\</span><span class="s2">Steam</span><span class="se">\\</span><span class="s2">Steam.exe&quot;</span><span class="p">,))</span>
<span class="n">follow_proc</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">js</span><span class="p">,</span> <span class="n">follow_proc_callback</span><span class="p">)</span>
<span class="n">frida</span><span class="o">.</span><span class="n">resume</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>

<span class="k">try</span> <span class="p">:</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">while</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="s1">&#39;q&#39;</span> <span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s1">&#39;r&#39;</span> <span class="p">:</span>
            <span class="k">for</span> <span class="n">script</span><span class="p">,</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">continue_events</span> <span class="p">:</span>
                <span class="n">script</span><span class="o">.</span><span class="n">post</span><span class="p">({</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">code</span><span class="p">})</span>
<span class="k">except</span> <span class="p">:</span>
    <span class="k">pass</span>

<span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="n">sessions</span><span class="p">)</span>
<span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">PIDs</span> <span class="p">:</span>
    <span class="k">try</span> <span class="p">:</span>
        <span class="n">Process</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
    <span class="k">except</span> <span class="p">:</span>
        <span class="k">pass</span>
</pre></div>


<p><br></p>
<div class="highlight"><pre><span></span><span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">QueryPerformanceCounter</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">findExportByName</span><span class="p">(</span><span class="s1">&#39;kernel32&#39;</span><span class="p">,</span> <span class="s1">&#39;QueryPerformanceCounter&#39;</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">CreateProcessInternalW</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">findExportByName</span><span class="p">(</span><span class="s1">&#39;kernel32&#39;</span><span class="p">,</span> <span class="s1">&#39;CreateProcessInternalW&#39;</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">SetTokenInformation</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">findExportByName</span><span class="p">(</span><span class="s1">&#39;kernel32&#39;</span><span class="p">,</span> <span class="s1">&#39;SetTokenInformation&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">SetTokenInformation</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> 
    <span class="nx">SetTokenInformation</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">findExportByName</span><span class="p">(</span><span class="s1">&#39;kernelbase&#39;</span><span class="p">,</span> <span class="s1">&#39;SetTokenInformation&#39;</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">RtlQueryPerformanceCounter</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">findExportByName</span><span class="p">(</span><span class="s1">&#39;ntdll&#39;</span><span class="p">,</span> <span class="s1">&#39;RtlQueryPerformanceCounter&#39;</span><span class="p">)</span>

<span class="kd">var</span> <span class="nx">CREATE_SUSPENDED</span> <span class="o">=</span> <span class="mh">0x00000004</span>

<span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">CreateProcessInternalW</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">onEnter</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;new process created!&#39;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">NULL</span><span class="p">)</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;\tlpApplicationName: &#39;</span><span class="o">+</span><span class="nx">Memory</span><span class="p">.</span><span class="nx">readUtf16String</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">NULL</span><span class="p">)</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;\tlpCommandLine: &#39;</span><span class="o">+</span><span class="nx">Memory</span><span class="p">.</span><span class="nx">readUtf16String</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">lpProcessInformation</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;\tlpProcessInformation: &#39;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">lpProcessInformation</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">dwCreationFlags</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;\tdwCreationFlags: &#39;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">dwCreationFlags</span><span class="p">);</span>
        <span class="nx">args</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="nx">or</span><span class="p">(</span><span class="nx">CREATE_SUSPENDED</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">onLeave</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">retval</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">retval</span><span class="p">.</span><span class="nx">toInt32</span><span class="p">())</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">PID</span> <span class="o">=</span> <span class="nx">Memory</span><span class="p">.</span><span class="nx">readU32</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">lpProcessInformation</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
                <span class="kd">var</span> <span class="nx">hProcess</span> <span class="o">=</span> <span class="nx">Memory</span><span class="p">.</span><span class="nx">readU32</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">lpProcessInformation</span><span class="p">)</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;CreateProcessInternalW SUCCEED: hProcess=&#39;</span><span class="o">+</span><span class="nx">hProcess</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; PID=&#39;</span><span class="o">+</span><span class="nx">PID</span><span class="p">);</span>
                <span class="nx">send</span><span class="p">({</span><span class="s1">&#39;event&#39;</span><span class="o">:</span> <span class="s1">&#39;new process&#39;</span><span class="p">,</span> <span class="s1">&#39;PID&#39;</span><span class="o">:</span> <span class="nx">PID</span><span class="p">,</span> <span class="s1">&#39;creation_flags&#39;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">dwCreationFlags</span><span class="p">.</span><span class="nx">toInt32</span><span class="p">()})</span>
                <span class="kd">var</span> <span class="nx">sync_op</span> <span class="o">=</span> <span class="nx">recv</span><span class="p">(</span><span class="s1">&#39;continue_&#39;</span><span class="o">+</span><span class="nx">PID</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{});</span>
                <span class="nx">sync_op</span><span class="p">.</span><span class="nx">wait</span><span class="p">();</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Resuming process...&#39;</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;CreateProcessInternalW FAILED!&#39;</span><span class="p">);</span>
            <span class="p">}</span>
    <span class="p">}</span>
<span class="p">});</span>


<span class="kd">var</span> <span class="nx">just_cause</span> <span class="o">=</span> <span class="nx">Process</span><span class="p">.</span><span class="nx">findModuleByName</span><span class="p">(</span><span class="s1">&#39;JustCause3.exe&#39;</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">just_cause</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;We are in JustCause3!&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">OEPs</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">just_cause_start</span> <span class="o">=</span> <span class="nx">just_cause</span><span class="p">.</span><span class="nx">base</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">just_cause_end</span> <span class="o">=</span> <span class="nx">just_cause</span><span class="p">.</span><span class="nx">base</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">just_cause</span><span class="p">.</span><span class="nx">size</span><span class="p">);</span>
    <span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">RtlQueryPerformanceCounter</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">onEnter</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span><span class="nx">just_cause_start</span><span class="p">.</span><span class="nx">compare</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">returnAddress</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">just_cause_end</span><span class="p">.</span><span class="nx">compare</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">returnAddress</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span> <span class="nx">OEPs</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">returnAddress</span><span class="p">)))</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">OEP_VA</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">returnAddress</span><span class="p">.</span><span class="nx">sub</span><span class="p">(</span><span class="nx">just_cause</span><span class="p">.</span><span class="nx">base</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">continue_event</span> <span class="o">=</span> <span class="s1">&#39;continue_&#39;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">threadId</span><span class="p">;</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Possible OEP: &#39;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">returnAddress</span><span class="o">+</span><span class="s1">&#39; (VA: &#39;</span><span class="o">+</span><span class="nx">OEP_VA</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">);</span>
                <span class="nx">send</span><span class="p">({</span><span class="s1">&#39;event&#39;</span><span class="o">:</span> <span class="s1">&#39;possible OEP&#39;</span><span class="p">,</span> <span class="s1">&#39;OEP&#39;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">returnAddress</span><span class="p">,</span> <span class="s1">&#39;OEP_VA&#39;</span><span class="o">:</span> <span class="nx">OEP_VA</span><span class="p">,</span> <span class="s1">&#39;continue_event&#39;</span><span class="o">:</span> <span class="nx">continue_event</span><span class="p">})</span>
                <span class="kd">var</span> <span class="nx">sync_op</span> <span class="o">=</span> <span class="nx">recv</span><span class="p">(</span><span class="nx">continue_event</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{});</span>
                <span class="nx">sync_op</span><span class="p">.</span><span class="nx">wait</span><span class="p">();</span>
                <span class="nx">OEPs</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">returnAddress</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>
    </div><!-- /.entry-content -->
    <div class="comments">
      <h2>Comments !</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_identifier = "trouver-loep.html";
        var disqus_url = "https://baboonrce.github.io/trouver-loep.html";
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//baboons-blog.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
    </div>

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://baboon.rce.free.fr/">L'ancien blog</a></li>
                            <li><a href="http://www.forumcrack.com">Forumcrack</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="https://github.com/baboonrce">La page github du blog</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <p>Powered by <a href="http://getpelican.com/">Pelican</a>. Theme <a href="https://github.com/blueicefield/pelican-blueidea/">blueidea</a>, inspired by the default theme.</p>
        </footer><!-- /#contentinfo -->

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-6180721-2', 'auto');
      ga('send', 'pageview');

    </script>
<script type="text/javascript">
    var disqus_shortname = 'baboons-blog';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>